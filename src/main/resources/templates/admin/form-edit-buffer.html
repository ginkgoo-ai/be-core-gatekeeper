<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Form Definition</title>
    <link rel="stylesheet" th:href="@{/css/buffer-ui.css}"/>
</head>
<body>
<div class="page-container">
    <header class="page-header">
        <div class="logo-title">
            <img th:src="@{https://uploads.linear.app/fee8b358-afe7-4f9d-8ec6-bbcc84fb2a90/aa77c589-9a7f-4c32-9403-547ffb4a2616/256x256/65e10f8a-3bf4-4aa9-86ad-4b4713e1a8db}"
                 alt="Logo" class="logo"/>
            <h1>Ginkgoo AI Gateway Keeper</h1>
        </div>
        <a th:href="@{/admin/forms}" class="btn btn-secondary">Back to List</a>
    </header>

    <div class="editor-layout-wrapper">
        <div id="formOutlinePanel" class="form-outline-panel">
            <h2>Form Outline</h2>
            <ul id="formOutlineTree">
            </ul>
        </div>

        <div class="card">
            <div class="card-body">
                <h1>Edit Form Definition</h1>

                <div th:if="${errorMessage}" class="alert alert-error">
                    <p th:text="${errorMessage}"></p>
                </div>

                <div class="form-info">
                    <p><strong>Form ID:</strong> <span th:text="${formDefinition.id}">ID</span></p>
                    <p><strong>Name:</strong> <span th:text="${formDefinition.name}">Name</span></p>
                    <p><strong>Version:</strong> <span th:text="${formDefinition.version}">1.0.0</span></p>
                    <p><strong>Created At:</strong> <span
                            th:text="${#temporals.format(formDefinition.createdAt, 'yyyy-MM-dd HH:mm:ss')}">Creation Date</span>
                    </p>
                    <p><strong>Updated At:</strong> <span
                            th:text="${#temporals.format(formDefinition.updatedAt, 'yyyy-MM-dd HH:mm:ss')}">Last Update</span>
                    </p>
                </div>

                <form th:action="@{/admin/forms/edit/{id}(id=${formDefinition.id})}" th:object="${updateRequest}"
                      method="post" id="editFormDefinitionForm" onsubmit="return validateFormBeforeSubmit()">
                    <div class="form-group">
                        <label class="field-label" for="formDescription">Description:</label>
                        <div class="field-input">
                            <textarea id="formDescription" th:field="*{description}"></textarea>
                        </div>
                        <div th:if="${#fields.hasErrors('description')}" th:errors="*{description}"
                             class="error-message"></div>
                    </div>

                    <div class="form-group">
                        <label class="field-label" for="formTargetAudience">Target Audience:</label>
                        <div class="field-input">
                            <input type="text" id="formTargetAudience" th:field="*{targetAudience}"/>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="field-label" for="formInitialLogic">Initial Logic (JSON):</label>
                        <div class="field-input">
                            <textarea id="formInitialLogic" th:field="*{initialLogic}"
                                      placeholder='e.g., {"prefillFields": ["userId"]}'></textarea>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="field-label" for="formSubmissionLogic">Submission Logic (JSON):</label>
                        <div class="field-input">
                            <textarea id="formSubmissionLogic" th:field="*{submissionLogic}"
                                      placeholder='e.g., {"targetService": "/api/downstream/submit"}'></textarea>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="field-label" for="status">Status:</label>
                        <div class="field-input">
                            <select id="status" th:field="*{status}">
                                <option th:each="statusOption : ${formStatuses}"
                                        th:value="${statusOption}"
                                        th:text="${statusOption.name()}">STATUS
                                </option>
                            </select>
                        </div>
                        <div th:if="${#fields.hasErrors('status')}" th:errors="*{status}" class="error-message"></div>
                    </div>

                    <hr>
                    <h3>Sections</h3>
                    <div id="sectionsContainer">
                        <!-- Existing sections will be populated via JavaScript -->
                        <th:block th:each="section, secStat : ${formDefinition.sections}">
                            <div class="section-container" th:attr="data-id=${section.id}">
                                <button type="button" class="btn btn-danger btn-sm remove-btn"
                                        onclick="this.closest('.section-container').remove(); updateNames('#sectionsContainer', '');">
                                    Remove Section
                                </button>
                                <h2 class="section-title">Section <span class="section-index"
                                                                        th:text="${secStat.index + 1}">1</span></h2>

                                <div class="form-group">
                                    <label class="field-label">Title:</label>
                                    <div class="field-input">
                                        <input type="text" data-name="title" th:value="${section.title}"/>
                                        <input type="hidden" data-name="id" th:value="${section.id}"/>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="field-label">Order:</label>
                                    <div class="field-input">
                                        <input type="number" data-name="order" th:value="${section.order}"/>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="field-label">Display Condition:</label>
                                    <div class="field-input">
                                        <input type="text" data-name="condition" th:value="${section.condition}"
                                           placeholder="e.g., fields['otherField'].value == 'someValue'"/>
                                    </div>
                                </div>

                                <h5>Fields</h5>
                                <div class="fieldsContainer">
                                    <!-- Existing fields -->
                                    <th:block th:each="field, fieldStat : ${section.fields}">
                                        <div class="field-container" th:attr="data-id=${field.id}">
                                            <button type="button" class="btn btn-danger btn-sm remove-btn"
                                                    onclick="this.closest('.field-container').remove(); updateNames('#sectionsContainer', '');">
                                                Remove Field
                                            </button>
                                            <h5>Field <span class="field-index"
                                                            th:text="${fieldStat.index + 1}">1</span></h5>

                                            <div class="form-group">
                                                <label class="field-label">Name (Key):</label>
                                                <div class="field-input">
                                                    <input type="text" data-name="name" th:value="${field.name}"/>
                                                    <input type="hidden" data-name="id" th:value="${field.id}"/>
                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <label class="field-label">Label:</label>
                                                <div class="field-input">
                                                    <input type="text" data-name="label" th:value="${field.label}"/>
                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <label class="field-label">Field Type:</label>
                                                <div class="field-input">
                                                    <select data-name="fieldType">
                                                        <option th:value="${T(com.ginkgooai.core.gatekeeper.domain.types.FieldType).TEXT}"
                                                                th:text="TEXT"
                                                                th:selected="${T(com.ginkgooai.core.gatekeeper.domain.types.FieldType).TEXT == field.fieldType}">
                                                            TEXT
                                                        </option>
                                                        <option th:value="${T(com.ginkgooai.core.gatekeeper.domain.types.FieldType).DATE}"
                                                                th:text="DATE"
                                                                th:selected="${T(com.ginkgooai.core.gatekeeper.domain.types.FieldType).DATE == field.fieldType}">
                                                            DATE
                                                        </option>
                                                        <option th:value="${T(com.ginkgooai.core.gatekeeper.domain.types.FieldType).RADIO}"
                                                                th:text="RADIO"
                                                                th:selected="${T(com.ginkgooai.core.gatekeeper.domain.types.FieldType).RADIO == field.fieldType}">
                                                            RADIO
                                                        </option>
                                                        <option th:value="${T(com.ginkgooai.core.gatekeeper.domain.types.FieldType).TEXTAREA}"
                                                                th:text="TEXTAREA"
                                                                th:selected="${T(com.ginkgooai.core.gatekeeper.domain.types.FieldType).TEXTAREA == field.fieldType}">
                                                            TEXTAREA
                                                        </option>
                                                    </select>
                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <label class="field-label">Static Options (JSON):</label>
                                                <div class="field-input">
                                                    <textarea data-name="staticOptions" th:text="${field.staticOptions}"
                                                          placeholder='e.g., [{"value":"v1","label":"Opt1"}]'></textarea>
                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <label class="field-label">Order:</label>
                                                <div class="field-input">
                                                    <input type="number" data-name="order" th:value="${field.order}"/>
                                                </div>
                                            </div>

                                            <h6>Validation Rules</h6>
                                            <div class="validationsContainer">
                                                <!-- Existing validation rules -->
                                                <th:block th:each="rule, ruleStat : ${field.validations}">
                                                    <div class="nested-item validation-rule"
                                                         th:attr="data-id=${rule.id}">
                                                        <button type="button" class="btn btn-danger btn-sm remove-btn"
                                                                onclick="this.closest('.validation-rule').remove(); updateNames('#sectionsContainer', '');">
                                                            Remove Rule
                                                        </button>
                                                        <h6>Rule <span class="validation-rule-index"
                                                                       th:text="${ruleStat.index + 1}">1</span></h6>

                                                        <div class="form-group">
                                                            <label class="field-label">Rule Type:</label>
                                                            <div class="field-input">
                                                                <select data-name="type">
                                                                    <option th:each="ruleType : ${ValidationRuleType.values()}"
                                                                            th:value="${ruleType}"
                                                                            th:text="${ruleType.name()}"
                                                                            th:selected="${ruleType == rule.type}">
                                                                        RULE_TYPE
                                                                    </option>
                                                                </select>
                                                                <input type="hidden" data-name="id"
                                                                       th:value="${rule.id}"/>
                                                            </div>
                                                        </div>

                                                        <div class="form-group">
                                                            <label class="field-label">Value:</label>
                                                            <div class="field-input">
                                                                <input type="text" data-name="value"
                                                                   th:value="${rule.value}"/>
                                                            </div>
                                                        </div>

                                                        <div class="form-group">
                                                            <label class="field-label">Error Message:</label>
                                                            <div class="field-input">
                                                                <input type="text" data-name="errorMessage"
                                                                   th:value="${rule.errorMessage}"/>
                                                            </div>
                                                        </div>

                                                        <div class="form-group">
                                                            <label class="field-label">Custom Function:</label>
                                                            <div class="field-input">
                                                                <input type="text" data-name="customFunction"
                                                                   th:value="${rule.customFunction}"/>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </th:block>
                                            </div>
                                            <button type="button"
                                                    class="btn btn-secondary btn-sm add-btn add-validation-rule-btn"
                                                    onclick="addValidationRule(this)">Add Validation Rule
                                            </button>
                                        </div>
                                    </th:block>
                                </div>
                                <button type="button" class="btn btn-secondary btn-sm add-btn add-field-btn"
                                        onclick="addField(this)">Add Field
                                </button>
                            </div>
                        </th:block>
                    </div>
                    <button type="button" class="btn btn-primary btn-sm add-btn" onclick="addSection()">Add Section
                    </button>
                    <hr>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <a th:href="@{/admin/forms}" class="btn btn-cancel">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Thymeleaf Templates for Dynamic Elements -->
<div th:fragment="sectionTemplate" class="section-container" style="display:none;" id="sectionTemplate">
    <button type="button" class="btn btn-danger btn-sm remove-btn"
            onclick="this.closest('.section-container').remove(); updateNames('#sectionsContainer', '');">Remove Section
    </button>
    <h2 class="section-title">New Section (<span class="section-index"></span>)</h2>
    <div class="form-group">
        <label class="field-label">Title:</label>
        <div class="field-input">
            <input type="text" data-name="title"/> <!-- JS will set the full name attribute -->
        </div>
    </div>
    <div class="form-group">
        <label class="field-label">Order:</label>
        <div class="field-input">
            <input type="number" data-name="order"/>
        </div>
    </div>
    <div class="form-group">
        <label class="field-label">Display Condition:</label>
        <div class="field-input">
            <input type="text" data-name="condition" placeholder="e.g., fields['otherField'].value == 'someValue'"/>
        </div>
    </div>

    <h5>Fields</h5>
    <div class="fieldsContainer">
        <!-- Fields will be dynamically added here -->
    </div>
    <button type="button" class="btn btn-secondary btn-sm add-btn add-field-btn" onclick="addField(this)">Add Field
    </button>
</div>

<div th:fragment="fieldTemplate" class="field-container" style="display:none;" id="fieldTemplate">
    <button type="button" class="btn btn-danger btn-sm remove-btn"
            onclick="this.closest('.field-container').remove(); updateNames('#sectionsContainer', '');">Remove Field
    </button>
    <h5>New Field (<span class="field-index"></span>)</h5>
    <div class="form-group">
        <label class="field-label">Name (Key):</label>
        <div class="field-input">
            <input type="text" data-name="name"/>
        </div>
    </div>
    <div class="form-group">
        <label class="field-label">Label:</label>
        <div class="field-input">
            <input type="text" data-name="label"/>
        </div>
    </div>
    <div class="form-group">
        <label class="field-label">Field Type:</label>
        <div class="field-input">
            <select data-name="fieldType">
                <option th:value="${T(com.ginkgooai.core.gatekeeper.domain.types.FieldType).TEXT}" th:text="TEXT">TEXT
                </option>
                <option th:value="${T(com.ginkgooai.core.gatekeeper.domain.types.FieldType).DATE}" th:text="DATE">DATE
                </option>
                <option th:value="${T(com.ginkgooai.core.gatekeeper.domain.types.FieldType).RADIO}" th:text="RADIO">
                    RADIO
                </option>
                <option th:value="${T(com.ginkgooai.core.gatekeeper.domain.types.FieldType).TEXTAREA}"
                        th:text="TEXTAREA">
                    TEXTAREA
                </option>
            </select>
        </div>
    </div>
    <div class="form-group">
        <label class="field-label">Static Options (JSON):</label>
        <div class="field-input">
            <textarea data-name="staticOptions" placeholder='e.g., [{"value":"v1","label":"Opt1"}]'></textarea>
        </div>
    </div>
    <div class="form-group">
        <label class="field-label">Order:</label>
        <div class="field-input">
            <input type="number" data-name="order"/>
        </div>
    </div>

    <h6>Validation Rules</h6>
    <div class="validationsContainer">
        <!-- Validation rules will be dynamically added here -->
    </div>
    <button type="button" class="btn btn-secondary btn-sm add-btn add-validation-rule-btn"
            onclick="addValidationRule(this)">Add Validation Rule
    </button>
</div>

<div th:fragment="validationRuleTemplate" class="nested-item validation-rule" style="display:none;"
     id="validationRuleTemplate">
    <button type="button" class="btn btn-sm btn-danger remove-btn"
            onclick="this.closest('.validation-rule').remove(); updateNames('#sectionsContainer', '');">Remove Rule
    </button>
    <h6>New Rule (<span class="validation-rule-index"></span>)</h6>
    <div class="form-group">
        <label class="field-label">Rule Type:</label>
        <div class="field-input">
            <select data-name="type">
                <option th:each="type : ${ValidationRuleType.values()}"
                        th:value="${type}"
                        th:text="${type.name()}">RULE_TYPE
                </option>
            </select>
        </div>
    </div>
    <div class="form-group">
        <label class="field-label">Value:</label>
        <div class="field-input">
            <input type="text" data-name="value"/>
        </div>
    </div>
    <div class="form-group">
        <label class="field-label">Error Message:</label>
        <div class="field-input">
            <input type="text" data-name="errorMessage"/>
        </div>
    </div>
    <div class="form-group">
        <label class="field-label">Custom Function:</label>
        <div class="field-input">
            <input type="text" data-name="customFunction"/>
        </div>
    </div>
</div>

<script th:inline="javascript">
  /*<![CDATA[*/

  function updateNames(containerSelector, prefix) {
    const container = document.querySelector(containerSelector) || document; // Allow targeting specific container or whole form for initial setup

    const sections = container.querySelectorAll(':scope > .section-container');
    sections.forEach((section, sectionIndex) => {
      const sectionPrefix = prefix + "sections[" + sectionIndex + "].";
      section.querySelectorAll(':scope > .form-group .field-input [data-name], :scope > .form-group input[type=hidden][data-name]').forEach(input => {
        input.name = sectionPrefix + input.dataset.name;
      });
      if (section.querySelector('.section-index')) section.querySelector('.section-index').textContent = sectionIndex + 1;


      const fieldsContainer = section.querySelector(':scope > .fieldsContainer');
      if (fieldsContainer) {
        const fields = fieldsContainer.querySelectorAll(':scope > .field-container');
        fields.forEach((field, fieldIndex) => {
          const fieldPrefix = sectionPrefix + "fields[" + fieldIndex + "].";
          field.querySelectorAll(':scope > .form-group .field-input [data-name], :scope > .form-group input[type=hidden][data-name]').forEach(input => {
            input.name = fieldPrefix + input.dataset.name;
          });
          if (field.querySelector('.field-index')) field.querySelector('.field-index').textContent = fieldIndex + 1;

          const validationsContainer = field.querySelector(':scope > .validationsContainer');
          if (validationsContainer) {
            const rules = validationsContainer.querySelectorAll(':scope > .validation-rule');
            rules.forEach((rule, ruleIndex) => {
              const rulePrefix = fieldPrefix + "validations[" + ruleIndex + "].";
              rule.querySelectorAll(':scope > .form-group .field-input [data-name], :scope > .form-group input[type=hidden][data-name]').forEach(input => {
                input.name = rulePrefix + input.dataset.name;
              });
              if (rule.querySelector('.validation-rule-index')) rule.querySelector('.validation-rule-index').textContent = ruleIndex + 1;
            });
          }
        });
      }
    });
  }

  function addSection() {
    const template = document.getElementById('sectionTemplate');
    const clone = template.cloneNode(true);
    clone.style.display = ''; // Make it visible
    clone.removeAttribute('id');
    document.getElementById('sectionsContainer').appendChild(clone);
    updateNames('#sectionsContainer', ''); // Update names for all sections
  }

  function addField(buttonElement) {
    const sectionDiv = buttonElement.closest('.section-container');
    const fieldsContainer = sectionDiv.querySelector('.fieldsContainer');
    const template = document.getElementById('fieldTemplate');
    const clone = template.cloneNode(true);
    clone.style.display = '';
    clone.removeAttribute('id');
    fieldsContainer.appendChild(clone);
    updateNames('#sectionsContainer', ''); // Re-evaluate all names from the top
  }

  function addValidationRule(buttonElement) {
    const fieldDiv = buttonElement.closest('.field-container');
    const validationsContainer = fieldDiv.querySelector('.validationsContainer');
    const template = document.getElementById('validationRuleTemplate');
    const clone = template.cloneNode(true);
    clone.style.display = '';
    clone.removeAttribute('id');
    validationsContainer.appendChild(clone);
    updateNames('#sectionsContainer', ''); // Re-evaluate all names from the top
  }

  function validateFormBeforeSubmit() {
    // 验证submissionLogic是否为有效的JSON
    const submissionLogic = document.getElementById('formSubmissionLogic').value;
    if (submissionLogic && submissionLogic.trim()) {
      try {
        JSON.parse(submissionLogic);
      } catch (e) {
        alert('提交逻辑(submissionLogic)必须是有效的JSON: ' + e.message);
        document.getElementById('formSubmissionLogic').focus();
        return false;
      }
    }

    // 验证initialLogic是否为有效的JSON
    const initialLogic = document.getElementById('formInitialLogic').value;
    if (initialLogic && initialLogic.trim()) {
      try {
        JSON.parse(initialLogic);
      } catch (e) {
        alert('初始逻辑(initialLogic)必须是有效的JSON: ' + e.message);
        document.getElementById('formInitialLogic').focus();
        return false;
      }
    }

    return true;
  }

  // Initialize names when the page loads
  document.addEventListener('DOMContentLoaded', function () {
    updateNames('#sectionsContainer', '');
    buildFormOutline(); // Build the outline
  });

  function buildFormOutline() {
    const outlineTreeUl = document.getElementById('formOutlineTree');
    if (!outlineTreeUl) return;
    outlineTreeUl.innerHTML = ''; // Clear existing outline

    const sectionsContainer = document.getElementById('sectionsContainer');
    if (!sectionsContainer) return;

    const sections = sectionsContainer.querySelectorAll(':scope > .section-container');

    sections.forEach((sectionElement, index) => {
      const sectionId = sectionElement.dataset.id || `section-${index}`;
      const titleInput = sectionElement.querySelector('input[data-name="title"]');
      const sectionTitle = titleInput ? titleInput.value : `Section ${index + 1}`;

      const sectionLi = document.createElement('li');
      sectionLi.classList.add('section-node');
      sectionLi.dataset.targetId = sectionId;

      const sectionHeaderDiv = document.createElement('div');
      sectionHeaderDiv.classList.add('section-header');

      const toggleSpan = document.createElement('span');
      toggleSpan.classList.add('toggle-icon');
      toggleSpan.textContent = '[+]';

      const titleSpan = document.createElement('span');
      titleSpan.classList.add('outline-section-title');
      titleSpan.textContent = sectionTitle;

      titleSpan.onclick = function () {
        scrollToElement(sectionId);
      };

      sectionHeaderDiv.appendChild(toggleSpan);
      sectionHeaderDiv.appendChild(titleSpan);
      sectionLi.appendChild(sectionHeaderDiv);

      const fieldsUl = document.createElement('ul');
      fieldsUl.classList.add('section-fields-list');

      const fieldsContainer = sectionElement.querySelector('.fieldsContainer');
      if (fieldsContainer) {
        const fields = fieldsContainer.querySelectorAll(':scope > .field-container');
        fields.forEach((fieldElement, fieldIndex) => {
          const fieldId = fieldElement.dataset.id || `field-${sectionId}-${fieldIndex}`;
          const labelInput = fieldElement.querySelector('input[data-name="label"]');
          const fieldLabel = labelInput ? labelInput.value : `Field ${fieldIndex + 1}`;
          const typeSelect = fieldElement.querySelector('select[data-name="fieldType"]');
          const fieldType = typeSelect ? typeSelect.value : 'N/A';

          const fieldLi = document.createElement('li');
          fieldLi.classList.add('field-node');
          fieldLi.dataset.targetId = fieldId;

          const fieldLabelSpan = document.createElement('span');
          fieldLabelSpan.classList.add('outline-field-label');
          fieldLabelSpan.textContent = fieldLabel;
          fieldLabelSpan.onclick = function () {
            scrollToElement(fieldId);
          };

          const fieldTypeSpan = document.createElement('span');
          fieldTypeSpan.classList.add('field-type-indicator');
          fieldTypeSpan.textContent = `(${fieldType})`;

          fieldLi.appendChild(fieldLabelSpan);
          fieldLi.appendChild(fieldTypeSpan);
          fieldsUl.appendChild(fieldLi);
        });
      }
      sectionLi.appendChild(fieldsUl);
      outlineTreeUl.appendChild(sectionLi);

      // Toggle functionality for section header (icon or title)
      sectionHeaderDiv.onclick = function (e) {
        // Prevent scroll if only toggle icon is clicked, allow scroll if title is clicked
        if (e.target === toggleSpan || e.target === sectionHeaderDiv) {
          const isHidden = fieldsUl.style.display === 'none';
          fieldsUl.style.display = isHidden ? 'block' : 'none';
          toggleSpan.textContent = isHidden ? '[-]' : '[+]';
        } else if (e.target === titleSpan) {
          scrollToElement(sectionId); // Already handled by titleSpan.onclick, but good for clarity
        }
      };
    });
  }

  function scrollToElement(elementId) {
    // Try to find by data-id first (for existing elements)
    let targetElement = document.querySelector(`[data-id="${elementId}"]`);
    // If not found by data-id (e.g. newly added unsaved element), try by dynamically assigned id
    if (!targetElement) {
      targetElement = document.getElementById(elementId);
    }

    if (targetElement) {
      targetElement.scrollIntoView({behavior: 'smooth', block: 'start'});
      // Optional: Add a temporary highlight effect
      targetElement.style.transition = 'outline 0.1s ease-in-out';
      targetElement.style.outline = '2px solid var(--primary-color)';
      setTimeout(() => {
        targetElement.style.outline = 'none';
      }, 1500);
    }
  }

  /*]]>*/
</script>

</body>
</html> 